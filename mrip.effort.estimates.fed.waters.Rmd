---
title: "MRIP effort estimates"
output: html_document
date: "2022-11-01"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
pacman::p_load(tidyverse, lubridate, here, RColorBrewer, gganimate, circlize, imputeTS, lme4, MuMIn, car, DHARMa, TSA, forecast, tscount, nlme)

```

FES fishing effort estimates for federal waters. Remember change in methodology starting in 2018. 

Cleaning this data, checking for coverage, and then joining it to the reshaped regs, precipitation, and RHL covariates (Can I ask Chris for fuel prices?)

```{r}
effort<-read_csv(here::here("data","mrip estimates","fed_eez_mrip_effort_series_modes_combined.csv"), skip=24)

short.states<-tolower(c("Massachusetts","Connecticut","Rhode Island","New York","New Jersey","Delaware","Maryland","Virginia","North Carolina"))
effort$State<-tolower(effort$State)

names(effort)<-c("status","year","state","nTrips","PSE")

effort.ts<-effort%>%
  filter(state%in%short.states)%>%
  mutate(nTrips=as.numeric(nTrips),
         PSE=as.numeric(PSE),
         SE=(PSE/100)*nTrips,
         CI.upper=nTrips+1.96*SE,
         CI.lower=nTrips-1.96*SE)

palette<-brewer.pal(8, "Dark2")

palette<-c(palette, "#000000")

ggplot(effort.ts)+
  geom_line(aes(x=year, y=nTrips, color=state))+
  geom_point(aes(x=year, y=nTrips, color=state))+
  geom_errorbar(aes(x=year, ymin=CI.lower, ymax=CI.upper), color="gray")+
  scale_color_manual(values=palette)+
  facet_grid(state~.)+
  theme_classic()
ggsave(here::here("figures","fes.effort.png"), height=12, width=6)

```

Missing 2 Connecticut estimates; 1997 and 2001. I'll probably want to impute those. CT has low fishign effort overall compared to other states, and it looks (from here) fairly stable. 

```{r}
ct<-filter(effort.ts, state=="connecticut")

ggplot(ct)+
  geom_line(aes(x=year, y=nTrips))+
  geom_point(aes(x=year, y=nTrips))+
  geom_errorbar(aes(x=year, ymin=CI.lower, ymax=CI.upper), color="gray")+
  theme_classic()

ct.inp<-na_interpolation(ct$nTrips, option="linear")

ggplot_na_imputations(ct$nTrips, ct.inp)
```

Linear imputation for two missing values. 

```{r}
ct$nTrips<-round(ct.inp)

effort.ts.no.ct<-filter(effort.ts, state!="connecticut")

effort.ts.ct.inp<-rbind.data.frame(effort.ts.no.ct, ct)

effort.ts.final<-arrange(effort.ts.ct.inp, year, state)
```


Read in covariate df

```{r}
cov.df<-read_csv(here::here("output regs","ssb.rain.rhl.regs.csv"))
```

So regulations weren't in place in federal waters (I think) until the 90s, but I have ssb data going back to at least 1989 for each stock. For now I can assume that 365 days/year were open in federal waters before implementation of federal regs. Rain data goes back as far as SSB estimates. RHL may be tricky--include (or substitute) an RHL indicator variable? 

I'm going to fit separate models (for now) for each species. (the response variable will be the same). My number of observations are limited because of late RHL implementation. it may be worth at some point just adding an indicator variable for RHL exists or not. 

```{r}
cov.df$state<-tolower(cov.df$state)

mod.df<-effort.ts.final%>%
  filter(year>1981 & year<2020)%>%
  select(year, state, nTrips, SE)%>%
  left_join(cov.df[,c("year", "state","nRainyDays","bsb.season","smf.season","scup.season",
                      "bsb.rhl","smf.rhl","scup.rhl",
                      "bsb.state.ssb","smf.state.ssb","scup.state.ssb")], by=c("year","state"))

write.csv(mod.df, here::here("summary output", "mod.data.rain.days.rhl.csv"))


hist(mod.df$nTrips)
hist(log(mod.df$nTrips))

hist(log10(mod.df$nTrips))
```
lognormal doesn't quite do it. 

```{r}
palette<-brewer.pal(length(unique(mod.df$state)), "Paired")
ggplot(mod.df)+
  geom_line(aes(x=year, y=nTrips, color=state))+
  scale_color_manual(values=palette)+
  theme_classic()
```
```{r}
ggplot(mod.df)+
  geom_line(aes(x=year, y=log(nTrips), color=state))+
  scale_color_manual(values=palette)+
  theme_classic()

```
This might go better if I drop Connecticut. Keep that in mind for later, CT has something strange happening whre the rec fishery just disappeared for 20 years. 

```{r}
mod.df.no.ct<-filter(mod.df, state!="connecticut")

ggplot(mod.df.no.ct)+
  geom_line(aes(x=year, y=log(nTrips), color=state))+
  scale_color_manual(values=palette)+
  theme_classic()

hist(mod.df.no.ct$nTrips)

hist(log(mod.df.no.ct$nTrips))

```
Yeah, that might help with the residual problems I was getting on the first version of these models. 


```{r}

mod.df.sc<-mod.df%>%
  mutate(logTrips=log(nTrips),
         nRain.sc=scale(nRainyDays, center=T, scale=T),
         bsb.daysOpen.sc=scale(bsb.season, center=T, scale=T),
         smf.daysOpen.sc=scale(smf.season, center=T, scale=T),
         scup.daysOpen.sc=scale(scup.season, center=T, scale=T),
         smf.rhl.sc=scale(smf.rhl, center=T, scale=T),
         bsb.rhl.sc=scale(bsb.rhl, center=T, scale=T),
         scup.rhl.sc=scale(scup.rhl, center=T, scale=T),
         bsb.rhl.ind=ifelse(is.na(bsb.rhl), 0, 1),
         smf.rhl.ind=ifelse(is.na(smf.rhl), 0, 1),
         scup.rhl.ind=ifelse(is.na(scup.rhl), 0, 1),
         bsb.ssb.sc=scale(bsb.state.ssb, center=T, scale=T),
         smf.ssb.sc=scale(smf.state.ssb, center=T, scale=T),
         scup.ssb.sc=scale(scup.state.ssb, center=T, scale=T))%>%
  # if I start testing species regs in separate models, I can extend the time series further. This time series is limited by black sea bass and summer flounder ssb availability
  filter(year>1988 & year<2018)


mod.basic<-lm(logTrips~nRain.sc+bsb.daysOpen.sc+smf.daysOpen.sc+scup.daysOpen.sc+
                smf.rhl.ind+bsb.rhl.ind+scup.rhl.ind+
                bsb.ssb.sc+smf.ssb.sc+scup.ssb.sc, data=mod.df.sc)

plot(mod.basic)

acf(resid(mod.basic))

pacf(resid(mod.basic))

vif(mod.basic)
```

Autocorrelation is a real problem, residuals are definitely not normally distributed. But reasonable variance of residuals at least. 

VIF is higher than optimal, but always lower than 10. 
```{r}
summary(mod.basic)
```
IN this initial model, only SSB has a significant effect on log n trips. positive effect for bsb and smf, negative for scup (for some reason). 

lme_simple_fit <- lme(y~1,random=~1|f,data=d,correlation=corAR1())

```{r}
mod.df.sc.drop<-filter(mod.df.sc, state!="connecticut")


mod.lme<-lme(logTrips~nRain.sc+bsb.daysOpen.sc+smf.daysOpen.sc+scup.daysOpen.sc+
                smf.rhl.ind+bsb.rhl.ind+scup.rhl.ind+
                bsb.ssb.sc+smf.ssb.sc+scup.ssb.sc,
                random=~1|state, data=mod.df.sc.drop,
               correlation=corAR1(form=~year|state))


plot(mod.lme)
# the residuals look really bad--that might be Connecticut?

plot(resid(mod.lme)~as.factor(mod.df.sc.drop$state))

summary(mod.lme)
```
```{r}
plot(ACF(mod.lme, alpha=0.05))
```
```{r}

mod.lme.ar1<-lme(logTrips~nRain.sc+bsb.daysOpen.sc+smf.daysOpen.sc+scup.daysOpen.sc+
                smf.rhl.ind+bsb.rhl.ind+scup.rhl.ind+
                bsb.ssb.sc+smf.ssb.sc+scup.ssb.sc,
                random=~1|state, data=mod.df.sc.drop,
                correlation=corAR1(form=~year|state))


plot(ACF(mod.lme.ar1))
mod.lme.ar1ma1<-lme(logTrips~nRain.sc+bsb.daysOpen.sc+smf.daysOpen.sc+scup.daysOpen.sc+
                smf.rhl.ind+bsb.rhl.ind+scup.rhl.ind+
                bsb.ssb.sc+smf.ssb.sc+scup.ssb.sc,
                random=~1|state, data=mod.df.sc.drop,
                correlation=corARMA(form=~year|state, p=1, q=1))

plot(ACF(mod.lme.ar1ma1))

mod.lme.ar2<-lme(logTrips~nRain.sc+bsb.daysOpen.sc+smf.daysOpen.sc+scup.daysOpen.sc+
                smf.rhl.ind+bsb.rhl.ind+scup.rhl.ind+
                bsb.ssb.sc+smf.ssb.sc+scup.ssb.sc,
                random=~1|state, data=mod.df.sc.drop,
                correlation=corARMA(form=~year|state, p=2, q=0))

plot(ACF(mod.lme.ar2ma1))


mod.lme.ar2ma2<-lme(logTrips~nRain.sc+bsb.daysOpen.sc+smf.daysOpen.sc+scup.daysOpen.sc+
                smf.rhl.ind+bsb.rhl.ind+scup.rhl.ind+
                bsb.ssb.sc+smf.ssb.sc+scup.ssb.sc,
                random=~1|state, data=mod.df.sc.drop,
                correlation=corARMA(form=~year|state, p=2, q=2))

plot(ACF(mod.lme.ar2ma2))

mod.lme.ar1ma2<-lme(logTrips~nRain.sc+bsb.daysOpen.sc+smf.daysOpen.sc+scup.daysOpen.sc+
                smf.rhl.ind+bsb.rhl.ind+scup.rhl.ind+
                bsb.ssb.sc+smf.ssb.sc+scup.ssb.sc,
                random=~1|state, data=mod.df.sc.drop,
                correlation=corARMA(form=~year|state, p=1, q=2))

plot(ACF(mod.lme.ar1ma2))

mod.lme.ar3<-lme(logTrips~nRain.sc+bsb.daysOpen.sc+smf.daysOpen.sc+scup.daysOpen.sc+
                smf.rhl.ind+bsb.rhl.ind+scup.rhl.ind+
                bsb.ssb.sc+smf.ssb.sc+scup.ssb.sc,
                random=~1|state, data=mod.df.sc.drop,
                correlation=corARMA(form=~year|state, p=3, q=0))
plot(ACF(mod.lme.ar3))

AICc(mod.lme.ar1, mod.lme.ar1ma1, mod.lme.ar2, mod.lme.ar2ma2, mod.lme.ar1ma2, mod.lme.ar3)
```

```{r}
plot(ACF(mod.lme.ar1ma1, resType="normalized",alpha=0.05))
```

