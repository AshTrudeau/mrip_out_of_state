---
title: "data wrangling"
output: html_document
date: "2022-09-06"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
pacman::p_load(tidyverse, lubridate, here)
```

MRIP raw trip data from here: https://www.st.nmfs.noaa.gov/st1/recreational/MRIP_Survey_Data/CSV/

```{r}



tbl<-list.files(path=here::here("data", "mrip raw"), pattern="trip*")

setwd(here::here("data","mrip raw"))
data<-sapply(tbl, read_csv, simplify=F)


setwd("C:/Users/ashle/Dropbox/MRIP out of state/mrip_out_of_state")

for(i in 1:length(data)){
   names(data[[i]])<-tolower(names(data[[i]]))
 
}


#all.data<-do.call("rbind", data)

 rbind.all.columns <- function(x, y) {
  
     x.diff <- setdiff(colnames(x), colnames(y))
     y.diff <- setdiff(colnames(y), colnames(x))
  
     x[, c(as.character(y.diff))] <- NA
  
     y[, c(as.character(x.diff))] <- NA
  
     return(rbind(x, y))
 }
```
 
 
 
```{r} 
 
all.data <- Reduce( rbind.all.columns, data)

write.csv(all.data, here::here("summary output", "all.trip.data.csv"))
```

If I don't want to do all of the above from scratch in the future: 

```{r}
all.data<-read_csv(here::here("summary output","all.trip.data.csv"))
```


```{r}
names(all.data)
```

site ID codes are not shared publically, so for now I will get centroid lat longs for county of intercept and county of residence.

county FIPS (and other cool spatial data) https://github.com/btskinner/spatial
```{r}
fips.convert<-read_csv(here::here("data","county_centers.csv"))

# clon10 is spatial center of county in 2010 census

fips<-fips.convert%>%
  select(fips, clat10, clon10)%>%
  mutate(fips=as.character(fips),
         # fips string needs to be same length as concatenated fips below in data.select; tripped me up before
         fips=str_pad(fips, 5, "left", "0"))%>%
  rename(cnty_fips=fips,
         latInt=clat10,
         longInt=clon10)

fips.res<-fips%>%
  rename(cnty_res_fips=cnty_fips,
         latRes=latInt,
         longRes=longInt)


```


```{r}
# I need to make a new column that combines state and county fips
data.select<-all.data%>%
  select(area_x, boat_hrs, cnty, cnty_res, dist, gear, hrs_dtd, hrsf, intsite, kod, mode_f, month, prim1_common, prim2_common, psu_id, id_code, st, st_res, strat_id, time, wave, year, zip)%>%
  mutate(cnty_res_fips=paste0(str_pad(as.character(st_res), 2, "left", "0"), str_pad(as.character(cnty_res), 3, "left", "0")),
         cnty_fips=paste0(str_pad(as.character(st), 2, "left", "0"), str_pad(as.character(cnty), 3, "left", "0")))%>%
  left_join(fips.res, by="cnty_res_fips")%>%
  left_join(fips, by="cnty_fips")%>%
  # remove the 48000 entries with missing coordinates
  filter(!is.na(latInt) & !is.na(latRes))%>%
  mutate(outOfState=ifelse(st==st_res, 0, 1),
         fromNorth=ifelse(latRes>latInt, 1, 0),
         fromSouth=ifelse(latRes<latInt, 1, 0))


data.outOfState<-filter(data.select, outOfState==1)  

hist(data.outOfState$fromNorth)
```
```{r}
hist(data.outOfState$fromSouth)
```
Huh. And what if I restrict it to mid-atlantic?

States: North Carolina, Virginia, Maryland, New Jersey, Delaware, Pennsylvania, New York, Connecticut, Rhode Island, Massachusetts, New Hampshire, and Maine
```{r}
midatl.outOfState<-filter(data.outOfState,
                          st%in%c(37, 51, 24, 34, 10, 42, 36, 9, 44, 25, 33, 23))

# that's cumbersome, just join the state/fips csv

state.fips<-read_csv(here::here("data","state.fips.csv"))

midatl.visitors<-left_join(midatl.outOfState, state.fips[,c("st", 'stusps')], by="st")

state.fips$st_res<-state.fips$st
state.fips$stusps_res<-state.fips$stusps

midatl.visitors<-left_join(midatl.visitors, state.fips[,c("st_res","stusps_res")], by="st_res")

ggplot(midatl.visitors)+
  geom_bar(aes(x=stusps, fill=stusps_res ), position="stack")
```
oof that's ugly. 

```{r}
midatl.visitors$fromWhere<-ifelse(midatl.visitors$fromNorth==1, "north", 
                                  ifelse(midatl.visitors$fromSouth==1,"south","NA"))

midatl.visitors$stusps<-factor(midatl.visitors$stusps, levels=c("NC","VA","MD","DE","NJ","NY","CT","RI","MA","NH","ME"))

ggplot(midatl.visitors)+
  geom_bar(aes(x=stusps, fill=fromWhere), position="stack")
```
Right, so clearly the further north you are, the more likely out of staters are to come from the south. That's obvious. Over time for each state, how has that number changed? Then further break it down by target species.  

```{r}
by.state<-midatl.visitors%>%
  group_by(stusps, year, fromWhere)%>%
  summarize(numberInt=n())%>%
  ungroup()

ggplot(by.state)+
  geom_line(aes(x=year, y=numberInt, color=fromWhere))+
  scale_color_manual(values=c("blue","red"))+
  facet_grid(stusps~., scales="free_y")+
  theme_classic()
ggsave(here::here("figures","north.south.by.state.png"), height=12, width=4)
```

What about coming from the south as a proportion of total effort? easier to interpret visually

```{r}
by.state.prop<-by.state%>%
  group_by(stusps, year)%>%
  mutate(totalInt=sum(numberInt))%>%
  mutate(prop=numberInt/totalInt)

ggplot(by.state.prop)+
  geom_line(aes(x=year, y=prop, color=fromWhere))+
  scale_color_manual(values=c("blue","red"))+
  facet_grid(stusps~.)+
  theme_classic()
ggsave(here::here("figures","north.south.prop.by.state.png"), height=12, width=4)

```
Yeah! Some possible trends there. It looks like VA is getting more people from the south, as is NJ, NY. In other states, trend of more people coming from the north: CT, MA, NH. People converging on states near higher distributions of popular stocks? Definitely worth separating by target species. For now lets' just do summer flounder, black sea bass, and scup. 

For simplicity, sticking with primary target species for now

```{r}
by.state.species<-midatl.visitors%>%
  group_by(stusps, year, prim1_common, fromWhere)%>%
  summarize(numberInt=n())%>%
  filter(prim1_common%in%c("SUMMER FLOUNDER","BLACK SEA BASS","SCUP"))%>%
  ungroup()

```
Summer flounder first

```{r}
smf<-filter(by.state.species, prim1_common=="SUMMER FLOUNDER")

ggplot(smf)+
  geom_line(aes(x=year, y=numberInt, color=fromWhere))+
  scale_color_manual(values=c("blue","red"))+
  facet_grid(stusps~., scales="free_y")+
  theme_classic()
ggsave(here::here("figures","smf.north.south.by.state.png"), height=12, width=4)

# let's make that a proportion again

smf.prop<-smf%>%
  group_by(stusps, year)%>%
  mutate(totalInt=sum(numberInt))%>%
  mutate(prop=numberInt/totalInt)

ggplot(smf.prop)+
  geom_line(aes(x=year, y=prop, color=fromWhere))+
  scale_color_manual(values=c("blue","red"))+
  facet_grid(stusps~.)+
  theme_classic()
ggsave(here::here("figures","smf.north.south.prop.by.state.png"), height=12, width=4)


```

Black sea bass

```{r}
bsb<-filter(by.state.species, prim1_common=="BLACK SEA BASS")

ggplot(bsb)+
  geom_line(aes(x=year, y=numberInt, color=fromWhere))+
  scale_color_manual(values=c("blue","red"))+
  facet_grid(stusps~., scales="free_y")+
  theme_classic()
ggsave(here::here("figures","bsb.north.south.by.state.png"), height=12, width=4)

# let's make that a proportion again

bsb.prop<-bsb%>%
  group_by(stusps, year)%>%
  mutate(totalInt=sum(numberInt))%>%
  mutate(prop=numberInt/totalInt)

ggplot(bsb.prop)+
  geom_line(aes(x=year, y=prop, color=fromWhere))+
  scale_color_manual(values=c("blue","red"))+
  facet_grid(stusps~.)+
  theme_classic()
ggsave(here::here("figures","bsb.north.south.prop.by.state.png"), height=12, width=4)


```

Hm. difficult to make anything out of that, other than many more people coming to fish for BSB (from all over) in NY, CT, RI, MA, when prior to 2010, there was not a lot of targeting of that species

Try scup, probably won't see much

```{r}
scp<-filter(by.state.species, prim1_common=="SCUP")

ggplot(scp)+
  geom_line(aes(x=year, y=numberInt, color=fromWhere))+
  scale_color_manual(values=c("blue","red"))+
  facet_grid(stusps~., scales="free_y")+
  theme_classic()
ggsave(here::here("figures","scp.north.south.by.state.png"), height=12, width=4)

# let's make that a proportion again

scp.prop<-scp%>%
  group_by(stusps, year)%>%
  mutate(totalInt=sum(numberInt))%>%
  mutate(prop=numberInt/totalInt)

ggplot(scp.prop)+
  geom_line(aes(x=year, y=prop, color=fromWhere))+
  scale_color_manual(values=c("blue","red"))+
  facet_grid(stusps~.)+
  theme_classic()
ggsave(here::here("figures","scp.north.south.prop.by.state.png"), height=12, width=4)


```

oh! that's interesting. really clear pattern of more people coming from north to RI, more people from south going to MA. 

Sudden spike in intercpets primarily targeting scup in NJ (especially from north), NY (from each direction), CT (from each direction) RI (from north), MA (from south)

To do: 
- match residence ZIP code to centroid lat long and US state
- compare residence lat long to access point lat long, classify as traveling north or south
- by state and year, summarize number of intercepts of out of state anglers traveling from 1) north and 2) south
- by state and year, summarize number of intercepts of all anglers traveling from 1) north and 2) south
- by state and year for summer flounder, black sea bass, and scup, summarize number of intercepts of out of state anglers traveling from north and south. 
- fit time series models: categorical year effect, linear effect, seasonality (categorical by wave, probably)
- maybe if I hate myself: collect state regulations to add as covariates. 
